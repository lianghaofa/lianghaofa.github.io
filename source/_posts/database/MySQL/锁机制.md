---
title: MySQL 锁机制
date: 2022-05-14 19:45:52
summary: MySQL 锁机制
categories: 数据库
tags:
- MySQL
---
## 锁机制



### MVCC 多版本并发控制

当前读 - 读取的是数据的最新版本，总是读取到最新的数据

- select ...... lock in share model  共享锁
- select ...... for update  排他锁
- update
- delete
- insert


快照读 - 读取的是历史版本的记录

- select ...... (没有加锁)


隔离级别

读未提交 

读已提交 RC  可以读取到最新的结果记录

可重复读 RR - 默认隔离级别   不可以读取到最新的结果记录

串行化


可见性算法


隐藏字段， 每行记录都包含用户不可见的字段  

DB_TRX_ID 创建或者最后一次修改该记录的事务ID

DB_ROW_ID 隐藏主键

DB_ROW_PTR 回滚指针 -> undolog 




readview  事务在进行快照读的时候产生的读视图

trx_list 系统活跃的事务ID

up_limit_id 列表中事务最小的ID

low_limit_id 系统尚未分配的下一个事务ID




1.事务是否提交

2.什么是否开启事务的隔离级别


RC ： 每次在进行快照读的时候都会生成新的readview

RR ： 只有在第一次进行快照读的时候才会生成readview，之后读操作都会用第一次生成的readview

RR 隔离级别什么时候会更新快照 ？ 触发当前读相关操作

update 会更新快照

幻读 - 当前读与快照读并发可能会出现幻读


原子性 - undolog

隔离性 - mvvc

持久性 - redolog

一致性 - 一致性依赖 原子性 隔离性 持久性

redolog - 二阶段提交  write ahead log


当花读 

快照读  


脏读 - 读取了尚未提交的数据 

不可重复读 - 一个事务内多次读取同一数据，数据结果不一致  - 锁定某些记录即可

幻读 - 记录数量与一开始发生了变化 - 防止幻读需要锁定整张表




### Innodb 引擎  

> 能锁表，也能锁行 
> 锁的对象是索引，不是数据块
#### 共享锁

#### 排他锁

#### 自增锁

#### 间隙锁




### MySAM 引擎

> 只能锁表

#### 共享读锁 

#### 读专写锁






