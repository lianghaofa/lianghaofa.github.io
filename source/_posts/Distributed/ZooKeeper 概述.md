---
title: ZooKeeper 概述
date: 2022-05-22 10:24:52
summary: ZooKeeper 概述
categories: 分布式
tags:
- ZooKeeper   

---
## ZooKeeper 概述




-对内 快速选举出Leader

-对外 数据 可靠、可用、一致性

最终一致性 - 一致性过程中，节点是否对外提供服务

### Paxos 算法 基于消息传递的一致性算法

奇数

- 3/2 + 1 = 2 允许一台挂

- 4/2 + 1 = 3 允许一台挂

- 5/2 + 1 = 3 允许两台挂
  
- 6/2 + 1 = 4 允许两台挂

为何过半？ 

- 不过半可能会出现多主

Paxos 算法 的前提 - 不存在拜占庭将军问题，计算环境中是可信的，不会被入侵所破坏的。


过半通过，两阶段提交。


可以请求到 Leader 或 Follower 节点

两阶段提交

- 预提交 - 生成事务日志ID

- ack - 等待Follower过半ack

- 提交 - Follower过半返回ack，更新内存中的 树形结构



1.发送给 Follower 的写请求，Follower 转发到 Leader，Leader 处理完回调给 Follower， 
回调时 Follower 挂了，数据怎么处理？ 回滚？



 
#### AZB 协议 - 过半机制、两阶段提交、数据同步

AZB 协议 前提是Leader存在

原子广播协议

- 原子 要么成功，要么失败，没有中间状态。

- 广播



### 选举

1.投票

2.选票

3.投票箱

4.过半机制

选举过程

- 3888 端口两两通信

- 只要任何人投票，都会触发leader发起自己的投票

- 推选制 



选举发生的时间点

- 启动

- Leader 宕机

- Follower挂掉后Leader发现已经没有过半Follower跟随自己了 - 不能对外提供服务


服务器

- 当前投了谁

- 投票箱


数据ID越新权重越高

zxid 

epoch,myid,zxid

事务性请求

非事务性请求

observer(watch) 节点



![节点类型](/medias/Distributed/1658541450271.png)


#### 脑裂

不遵循过半机制，脑裂，多个主




### 分布式锁

1.争抢锁，只能有一个人获得锁

2.获得锁的人，如果中途挂了，此锁就成死锁了。(临时节点基于session，session没了，锁就断了)

3.获得锁的人，如何释放锁？

4.锁被释放或删除了，别人如何知道？
4.1 主动轮询，心跳。 弊端：延迟，锁被释放了，也要等到轮询才能发现。如果轮询的机器多了，消耗资源。
4.2 watch:解决延迟问题，sequence 节点，解决大量的锁竞争
